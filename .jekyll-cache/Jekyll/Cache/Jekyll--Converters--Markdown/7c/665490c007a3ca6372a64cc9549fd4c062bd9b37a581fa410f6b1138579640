I"“/<p>By default, Docker donâ€™t limit the amount of memory and CPU that a container can use. The container can use as much of a given resources as the hostâ€™s kernel scheduler allows.</p>

<p>Itâ€™s important to limit the resources that can consume a container. When the kernel detect that the computer have little memory, itâ€™s throws an <code class="language-plaintext highlighter-rouge">Out of Memory Exception</code> and starts killing process to free up memory, and this can bring the entire system down. To avoid that circunstancies, you must execute test in your application and calculate the amount of resources needed, and then limit the container to use a rational amount of resources.</p>

<p>You can view the statistics of your Docker containers with the  <code class="language-plaintext highlighter-rouge">stats</code> command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>docker stats <span class="o">[</span>docker_image]
</code></pre></div></div>

<h2 id="configure-system-to-enabled-limiting-resources">Configure system to enabled limiting resources</h2>

<p>Before limiting the resources of a container itâ€™s important to check that the kernel of the host allow this. Run the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>docker info
</code></pre></div></div>

<p>If you receive the following warning in the output:</p>

<pre><code class="language-output">WARNING: Noswaplimitsupport
</code></pre>

<p>So, you must enable the functionality in the kernel. To achieve this, edit the file that is located in <code class="language-plaintext highlighter-rouge">/etc/default/grub</code>, and then add the following line:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GRUB_CMDLINE_LINUX="cgroup_enable=memory swapaccount=1"
</code></pre></div></div>

<p>Save the changes and update the GRUB configuration with the command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>update-grub
</code></pre></div></div>

<p>Then, reboot your machine for the changes to take place:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>shutdown <span class="nt">-r</span>
</code></pre></div></div>

<p>Once the machine has restarted, make sure that the changes have been made:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>docker info
</code></pre></div></div>

<p>You shouldnâ€™t received the warning <code class="language-plaintext highlighter-rouge">WARNING: Noswaplimitsupport</code> this time.</p>

<h2 id="limit-container-memory-access">Limit Container Memory Access</h2>

<p>There are different ways to limit RAM to containers:</p>

<h3 id="configuring-the-maximum-amount-of-memory-a-container-can-use">Configuring the maximum amount of memory a container can use</h3>

<p>Add the  <code class="language-plaintext highlighter-rouge">--memory</code> option to the command <code class="language-plaintext highlighter-rouge">docker run</code> for limit the maximum amount of memory of a container. Within the command, specify how much memory you want dedicate to that specific container.</p>

<p>The syntax is the following:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>docker run <span class="nt">-it</span> <span class="nt">--memory</span><span class="o">=</span><span class="s2">"[memory_limit]"</span> <span class="o">[</span>docker_image]
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">memory_limit</code> should be a positive integer following by the suffix b, k, m o g (short for bytes, kilobytes, megabytes o gigabytes).</p>

<p>For example, to run an instance of a Ubuntu container and configurate a limit to 1GB, the command should be as follow:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>docker run <span class="nt">-it</span> <span class="nt">--memory</span><span class="o">=</span><span class="s2">"1g"</span> ubuntu
</code></pre></div></div>

<h3 id="defining-the-amount-of-memory-that-a-container-can-swap-to-disk">Defining the amount of memory that a container can swap to disk</h3>

<p>Add the option <code class="language-plaintext highlighter-rouge">swamp</code> to store data even after all RAM assigned to the container has been used up. It does this by ignoring the memory limitation and writing directly to the disk. Although this is a useful feature, it is not a recommended practice as it slows down performance.</p>

<p>The option <code class="language-plaintext highlighter-rouge">swamp</code> includes the total amount of non-swap memory plus the amount of swap memory reserved as backup.</p>

<p>The syntax is the following:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>docker run <span class="nt">-it</span> <span class="nt">--memory</span><span class="o">=</span><span class="s2">"[memory_limit]"</span> <span class="nt">--memory-swap</span><span class="o">=</span><span class="s2">"[memory_limit]"</span> <span class="o">[</span>docker_image]
</code></pre></div></div>

<p>For example, to configure <code class="language-plaintext highlighter-rouge">--memory</code> to 1 GB, the amount of swap memory has to be greather than that. To run a container with an additional 1GB of swap memory, you should configurate the option <code class="language-plaintext highlighter-rouge">swamp</code> to 2 GB.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>docker run <span class="nt">-it</span> <span class="nt">--memory</span><span class="o">=</span><span class="s2">"1g"</span> <span class="nt">--memory-swap</span><span class="o">=</span><span class="s2">"2g"</span> ubuntu
</code></pre></div></div>

<p>If you donâ€™t want to use swap memory, give <code class="language-plaintext highlighter-rouge">--memory</code> and <code class="language-plaintext highlighter-rouge">--memory-swap</code> the same values.</p>

<h3 id="set-soft-limit-to-container-memory">Set soft limit to container memory</h3>

<p>When you limit the memory access to a container with the option <code class="language-plaintext highlighter-rouge">--memory</code> you are setting a hard limit that the container canâ€™t to surpassed. However, you can set a soft limit with the option <code class="language-plaintext highlighter-rouge">--memory-reserve</code> which warns when the container reaches the end of its assigned memory but doesnâ€™t stop any of its services.</p>

<p>If <code class="language-plaintext highlighter-rouge">--memory</code> limitations see are not set, setting the soft limit with <code class="language-plaintext highlighter-rouge">--memory-reservation</code> doesnâ€™t completely limit container space. If you have both features enabled, the soft limit is always lower than the maximum space capacity.</p>

<p>For example, if you want that a Ubuntu container had a memory reservation of 750 MB and the maximun RAM capacity of 1 BG, the command is as following:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>docker run <span class="nt">-it</span> <span class="nt">--memory</span><span class="o">=</span><span class="s2">"1g"</span> <span class="nt">--memory-reservation</span><span class="o">=</span><span class="s2">"750m"</span> ubuntu
</code></pre></div></div>

<h2 id="limit-container-cpu-access">Limit Container CPU Access</h2>

<p>As memory limit, there are different ways to configure CPU limit:</p>

<h3 id="defining-a-cpu-limit">Defining a CPU limit</h3>

<p>The option <code class="language-plaintext highlighter-rouge">--cpus</code> allows you specify how much of the available CPU resources a container can use.</p>

<p>For example, if the host machine has two CPUs and you set <code class="language-plaintext highlighter-rouge">--cpus="1.5"</code>, the container is guaranteed at most one and a half of the CPUs.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>docker run <span class="nt">-it</span> <span class="nt">--cpus</span><span class="o">=</span><span class="s2">"1.5"</span> ubuntu
</code></pre></div></div>

<h3 id="assigning-dedicated-cpu-to-containers">Assigning dedicated CPU to containers</h3>

<p>You can use the option <code class="language-plaintext highlighter-rouge">--cpuset-cpus</code> to limit the specific CPUs or cores a container can use. There are two different formats:</p>

<ul>
  <li>a comma-separated list. For example: <code class="language-plaintext highlighter-rouge">0,2,4</code></li>
  <li>a hyphen-separated range. For example: <code class="language-plaintext highlighter-rouge">1-3</code></li>
</ul>

<p>CPUs are addressed using a zero based index. This means 0,2,4 tells Docker to allocate compute-power from the first, third, and fifth CPU.</p>

<p>For example, to run a container y allocate just the second CPU, the command is as following:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-d</span> <span class="nt">--rm</span> <span class="nt">--cpuset-cpus</span> 1 ubuntu <span class="nt">-c</span> 8 <span class="nt">-t</span> 20s
</code></pre></div></div>

<p>Because the set of CPUs is selected explicitly, the container is limited to the capacity of the set.</p>

<h3 id="cpu-shares-for-docker-containers">CPU Shares for Docker containers</h3>

<p>The option <code class="language-plaintext highlighter-rouge">--cpu-shares</code> allows you to give access to a greater or lesser proportion of the host machineâ€™s CPU cycles. By default, itâ€™s configure to 1024. To give a container relatively less CPU time set <code class="language-plaintext highlighter-rouge">--cpu-shares</code> to lower than 1024. To give a container relatively more CPU set <code class="language-plaintext highlighter-rouge">--cpu-shares</code> for Docker run to a value greater than 1024.</p>

<p>This is only enforced when CPU cycles are constrained. When plenty of CPU cycles are available, all containers use as much CPU as they need. In that way, this is a soft limit. It prioritizes container CPU resources for the available CPU cycles. It does not guarantee or reserve any specific CPU access.</p>

<p>For example, to run a container with less resources shared, the command is as following:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>docker run <span class="nt">-it</span> <span class="nt">--cpus-shares</span><span class="o">=</span><span class="s2">"700"</span> ubuntu
</code></pre></div></div>

<p>If <code class="language-plaintext highlighter-rouge">--cpus</code> or <code class="language-plaintext highlighter-rouge">--cpu-quota</code> is set then even if there is no contention for CPU time the container will be limited based. This can be good for predictable resource usage but is generally bad for utilisation.</p>

<h2 id="sources">Sources</h2>

<ul>
  <li><a href="https://phoenixnap.com/kb/docker-memory-and-cpu-limit">How to Set Docker Memory and CPU Usage Limit</a></li>
  <li><a href="https://docs.docker.com/config/containers/resource_constraints/#configure-the-default-cfs-scheduler/">Runtime options with Memory, CPUs, and GPUs</a></li>
  <li><a href="https://www.batey.info/cgroup-cpu-shares-for-docker.html">CPU Shares for Docker containers</a></li>
  <li><a href="https://www.thorsten-hans.com/docker-container-cpu-limits-explained">Docker Container CPU Limits Explained</a></li>
</ul>
:ET