I"ƒ#<p>El par√°metro <code class="language-plaintext highlighter-rouge">max_connections</code> determina el n√∫mero m√°ximo de conexiones simult√°neas en el servidor de base de datos. Por defecto PostgreSQL establece el l√≠mite m√°ximo de conexiones en 100.</p>

<p>Si el l√≠mite establecido en la base de datos se supera, PostgreSQL lanzar√° la siguiente excepci√≥n:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>org.postgresql.util.PSQLException: FATAL: sorry, too many clients already.
</code></pre></div></div>

<p>Ante este error podemos encontrar las siguientes soluciones:</p>

<ol>
  <li>Incrementar el par√°metro <code class="language-plaintext highlighter-rouge">max_connections</code>. Esto es sencillo de realizar pero probablemente solucione el problema temporalmente.</li>
  <li>Una posible causa de este error es que las aplicaciones que se conectan a la base de datos no est√©n implementado correctamente el cierre de la conexiones. Generando que se sigan abriendo conexiones sin cerrar otras que ya no se usan. Por lo tanto deber√≠a chequear el c√≥digo donde se abre una conexi√≥n y verificar que la misma se cierre correctamente. Para ayudar a encontrar la aplicaci√≥n que hace un mal uso de la conexi√≥n, puede dar diferentes nombres de usuario / contrase√±as a las aplicaciones que podr√≠an no liberar las conexiones, y luego buscar en pg_stat_activity para averiguar cu√°l no se est√° cerrando las conexiones.</li>
  <li>Usar un <em>pool</em> de conexiones en las aplicaciones. Un <em>pool</em> de conexiones mantiene un n√∫mero de conexiones a la base datos abiertas. De esta manera en lugar de abrir tu mismo una nueva conexi√≥n simplemente solicitas alguna de las disponibles, mejorando de esta forma la <em>performance</em> de tu aplicaci√≥n, ya que abrir y cerrar conexiones de base de datos suponen un coste de procesador. Para m√°s detalle ver <a href="/Connections-pool">aqu√≠</a>.</li>
</ol>

<p>Particularmente nos vamos a centrar sobre el punto 1, es decir, la configuraci√≥n del par√°metro max_connections.</p>

<p>Sobre este par√°metro debe tener en cuenta lo siguiente:</p>

<blockquote>
  <p>Cada conexi√≥n PostgreSQL consume memoria RAM para administrar la conexi√≥n o el cliente que la usa. Cuantas m√°s conexiones tenga, m√°s memoria RAM se utilizar√° para este fin, en lugar de utilizarse para ejecutar la base de datos.</p>
</blockquote>

<p>Por lo general, una aplicaci√≥n bien codificada no necesita una gran cantidad de conexiones. Si tiene una aplicaci√≥n que necesita una gran cantidad de conexiones, considere usar una herramienta como pg_bouncer que puede agrupar las conexiones por usted. Como cada conexi√≥n consume RAM, deber√≠a intentar minimizar su uso y por lo tanto es importante no abusar.</p>

<h2 id="comandos-√∫tiles-para-modificar-el-par√°metro-max_connections"><a href="#header-2"></a>Comandos √∫tiles para modificar el par√°metro max_connections</h2>

<h3 id="cheque√©-el-valor-del-par√°metro-actual"><a href="#header-3"></a>Cheque√© el valor del par√°metro actual</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SHOW</span> <span class="n">max_connections</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="liste-la-cantidad-de-conexiones-actualmente-usadas"><a href="#header-3"></a>Liste la cantidad de conexiones actualmente usadas</h3>

<p>Este comando permite ver qui√©n/qu√©/cu√°ndo/d√≥nde se mantiene abiertas las conexiones:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">pg_stat_activity</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="liste-la-cantidad-de-conexiones-actualmente-usadas-1"><a href="#header-3"></a>Liste la cantidad de conexiones actualmente usadas</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">pg_stat_activity</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="ver-con-detalle-las-conexiones-actuales"><a href="#header-3"></a>Ver con detalle las conexiones actuales</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">pg_stat_activity</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="editar-el-par√°metro-max_connections"><a href="#header-3"></a>Editar el par√°metro max_connections</h3>

<p>Sobre esto, es importante aclarar que incrementar solamente <code class="language-plaintext highlighter-rouge">max_connections</code> es una mala idea. Tambi√©n deber√≠a incrementar <code class="language-plaintext highlighter-rouge">shared_buffers</code> y <code class="language-plaintext highlighter-rouge">kernel.shmmax</code>.</p>

<p>El par√°metro <code class="language-plaintext highlighter-rouge">shared_buffers</code> determina cuanta memoria usar√° PostgreSQL para almacenar datos en cach√©. Las conexiones utilizan la memoria en los <em>shared buffers</em>.
Tenga en cuenta las siguientes consideraciones:</p>

<ul>
  <li>Si tiene un servidor con 1 GB o m√°s de RAM, un valor inicial razonable para <code class="language-plaintext highlighter-rouge">shared_buffers</code> es 25% de la memoria de su servidor.</li>
  <li>Es poco probable que el uso de m√°s del 40% de RAM funcione mejor que una cantidad menor (como el 25%)</li>
  <li>Si su servidor o la compilaci√≥n de PostgreSQL es de 32 bits, puede que no sea pr√°ctico establecer <code class="language-plaintext highlighter-rouge">shared_buffers</code> por encima de 2 ~ 2.5GB.</li>
</ul>

<p>Aclarado esto, continuaremos con los pasos para modificar estos par√°metros.</p>

<p>Busque el archivo de configuraci√≥n de PostgreSQL</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SHOW</span> <span class="n">config_file</span><span class="p">;</span>
</code></pre></div></div>

<p>Edite el archivo de configuraci√≥n y actualice el par√°metro <code class="language-plaintext highlighter-rouge">max_connections</code> y <code class="language-plaintext highlighter-rouge">shared_buffers</code>. Supongamos que tenemos un server con 8GB de memoria, y en el mismo archivo <code class="language-plaintext highlighter-rouge">postgresql.conf</code>, actualice el valor del par√°metro <code class="language-plaintext highlighter-rouge">shared_buffers</code> a 2GB (25%).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>max_connections = 100
shared_buffers = 2GB
</code></pre></div></div>

<p>Para que los cambios tengan efecto reinicie el servicio de PostgreSQL:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl restart postgresql
</code></pre></div></div>

<p>Deber√≠a aumentar el tama√±o del segmento m√°ximo del kernel para que sea un poco m√°s grande que <code class="language-plaintext highlighter-rouge">shared_buffers</code>. En el archivo <code class="language-plaintext highlighter-rouge">/etc/sysctl.conf</code>, configure el par√°metro como se muestra a continuaci√≥n. Entrar√° en vigor cuando se reinicie postgreSQL (la siguiente l√≠nea hace que el kernel tenga un m√°ximo de 2.3GB)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kernel.shmmax=2469606195
</code></pre></div></div>

<p>En los sistemas modernos, <code class="language-plaintext highlighter-rouge">kernel.shmmax</code> ya es muy alto y no debe cambiarse. Para ver cual est√° configurado puede ejecutar el siguiente comando:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> /proc/sys/kernel/shmmax
</code></pre></div></div>

<blockquote>
  <p><strong>Nota:</strong> Puede usar la p√°gina <a href="https://pgtune.leopard.in.ua/">PGTune</a> para obtener los par√°metros √≥ptimos para su sistema.</p>
</blockquote>

<h1 id="fuentes"><a href="#header-1"></a>Fuentes</h1>

<ul>
  <li><a href="https://stackoverflow.com/questions/2757549/org-postgresql-util-psqlexception-fatal-sorry-too-many-clients-already">org.postgresql.util.PSQLException: FATAL: sorry, too many clients already</a></li>
  <li><a href="https://dadruid5.com/2017/07/20/checking-and-increasing-the-max-connections-in-postgresql/">Checking and Increasing the Connection Limit in PostgreSQL</a></li>
  <li><a href="https://devcoops.com/resolve-sorry-too-many-clients-postgres-issue/">How to resolve PostgreSQL FATAL: sorry, too many clients already</a></li>
  <li><a href="https://stackoverflow.com/questions/30778015/how-to-increase-the-max-connections-in-postgres">How to increase the max connections in postgres?</a></li>
</ul>
:ET