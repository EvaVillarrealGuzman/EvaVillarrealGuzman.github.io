<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-translate-customization" content="108d9124921d80c3-80e20d618ff053c8-g4f02ec6f3dba68b7-c">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Connection Pooling | Eva Villarreal Guzmán</title>
<meta name="generator" content="Jekyll v4.2.2">
<meta property="og:title" content="Connection Pooling">
<meta name="author" content="Eva Villarreal Guzmán">
<meta property="og:locale" content="en_US">
<meta name="description" content="Database connections are fairly expensive operations. Such operation involved the following sequence of steps:">
<meta property="og:description" content="Database connections are fairly expensive operations. Such operation involved the following sequence of steps:">
<link rel="canonical" href="http://localhost:4000/postgres/2021/12/13/connections-pool.html">
<meta property="og:url" content="http://localhost:4000/postgres/2021/12/13/connections-pool.html">
<meta property="og:site_name" content="Eva Villarreal Guzmán">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2021-12-13T00:00:00-03:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="Connection Pooling">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Eva Villarreal Guzmán"},"dateModified":"2021-12-13T00:00:00-03:00","datePublished":"2021-12-13T00:00:00-03:00","description":"Database connections are fairly expensive operations. Such operation involved the following sequence of steps:","headline":"Connection Pooling","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/postgres/2021/12/13/connections-pool.html"},"url":"http://localhost:4000/postgres/2021/12/13/connections-pool.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="shortcut icon" href="">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-noto-sans@0.0.72/index.min.css">
  <link rel="stylesheet" href="/assets/css/main.css">
  <script src="/assets/js/main.js"></script><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Eva Villarreal Guzmán">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
<!-- and it's easy to individually load additional languages -->
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/go.min.js"></script>



















<script>
// Init highlight js
document.addEventListener('DOMContentLoaded', function(event) {
  var els = document.querySelectorAll('pre code')

  function addLangData(block) {
    var outer = block.parentElement.parentElement.parentElement;
    var lang = block.getAttribute('data-lang');
    for (var i = 0; i < outer.classList.length; i++) {
      var cls = outer.classList[i];
      if (cls.startsWith('language-')) {
        lang = cls;
        break;
      }
    }
    if (!lang) {
      cls = block.getAttribute('class');
      lang = cls ? cls.replace('hljs ', '') : '';
    }
    if (lang.startsWith('language-')) {
      lang = lang.substr(9);
    }
    block.setAttribute('class', 'hljs ' + lang);
    block.parentNode.setAttribute('data-lang', lang);
  }

  function addBadge(block) {
    var enabled = ('true' || 'true').toLowerCase();
    if (enabled == 'true') {
      var pre = block.parentElement;
      pre.classList.add('badge');
    }
  }

  function handle(block) {
    addLangData(block);
    addBadge(block)
    hljs.highlightBlock(block);
  }

  for (var i = 0; i < els.length; i++) {
    var el = els[i];
    handle(el);
  }
});
</script>

<style>
  /* code language badge */
  pre.badge::before {
    content: attr(data-lang);
    color: #fff;
    background-color: #ff4e00;
    padding: 0 .5em;
    border-radius: 0 2px;
    text-transform: uppercase;
    text-align: center;
    min-width: 32px;
    display: inline-block;
    position: absolute;
    right: 0;
  }

  /* fix wrong badge display for firefox browser */
  code > table pre::before {
    display: none;
  }
</style>
</head>
<body>



























































































































<header class="site-header " role="banner">

  <div class="wrapper">
    <div class="site-header-inner">
<span class="site-brand"><a class="site-brand-inner" rel="author" href="/">
  <img class="site-favicon" title="Eva Villarreal Guzmán" src="" onerror="this.style.display='none'">
  Eva Villarreal Guzmán
</a>
</span><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger">
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewbox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
              </svg>
            </span>
          </label>

          <div class="trigger">
<a class="page-link" href="/about.html">ABOUT</a><a class="page-link" href="/archives.html">ARCHIVES</a><a class="page-link" href="/categories.html">CATEGORIES</a><a class="page-link" href="/">HOME</a><a class="page-link" href="/tags.html">TAGS</a>









<span class="page-link">



<div id="google_translate_element" style="display: none;">
</div>

<span class="ct-language">
  <ul class="list-unstyled ct-language-dropdown">
    
      <li>
        <a href="#" class="lang-select" data-lang="en">
          
          <img src="https://cdn.countryflags.com/thumbs/united-states-of-america/flag-400.png" title="English">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="es">
          
          <img src="https://cdn.countryflags.com/thumbs/spain/flag-400.png" title="Spanish">
          
        </a>
      </li>
    
  </ul>
</span>

<script type="text/javascript">
function googleTranslateElementInit() {
  new google.translate.TranslateElement({
    pageLanguage: 'en',
    autoDisplay: false,
    layout: google.translate.TranslateElement.InlineLayout.VERTICAL
  }, 'google_translate_element');

  // Links to cross-origin destinations are unsafe
  var gll = document.getElementsByClassName('goog-logo-link')[0];
  if (gll) {
    gll.setAttribute('rel', 'noopener');
  }

  function restoreLang() {
    var iframe = document.getElementsByClassName('goog-te-banner-frame')[0];
    if (!iframe) return;

    var innerDoc = iframe.contentDocument || iframe.contentWindow.document;
    var restore_el = innerDoc.getElementsByTagName("button");

    for (var i = 0; i < restore_el.length; i++) {
      if (restore_el[i].id.indexOf("restore") >= 0) {
        restore_el[i].click();
        var close_el = innerDoc.getElementsByClassName("goog-close-link");
        close_el[0].click();
        return;
      }
    }
  }

  function triggerHtmlEvent(element, eventName) {
    var event;
    if (document.createEvent) {
      event = document.createEvent('HTMLEvents');
      event.initEvent(eventName, true, true);
      element.dispatchEvent(event);
    } else {
      event = document.createEventObject();
      event.eventType = eventName;
      element.fireEvent('on' + event.eventType, event);
    }
  }

  var googleCombo = document.querySelector("select.goog-te-combo");
  var langSelect = document.querySelector('.ct-language');
  langSelect.addEventListener('click', function(event) {
    if (!event.target) {
      return;
    }

    var selected = document.querySelector('.ct-language .ct-language-selected');
    if (selected) {
      selected.classList.remove('ct-language-selected');
    }

    var target = event.target;
    while (target && target !== langSelect ) {
      if (target.matches('.lang-select')) {
        break;
      }
      target = target.parentElement;
    }

    if (target && target.matches('.lang-select')) {
      var lang = target.getAttribute('data-lang');
      if (googleCombo.value == lang) {
        restoreLang();
      } else {
        target.parentElement.classList.add('ct-language-selected');
        googleCombo.value = lang;
        triggerHtmlEvent(googleCombo, 'change');
      }
    }

    event.preventDefault();
  });
}
</script>

<script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
</span>
</div>
        </nav>
</div>
  </div>
</header>

<script>
  function initHeader() {
    var lastScrollY = getScrollPos().y;
    var documentElement = document.documentElement;

    function storeScrollData() {
      var y = getScrollPos().y;var scrollStatus = "";

      if (y <= 0) {
        scrollStatus = "top";
      } else if ((window.innerHeight + y) >= document.body.offsetHeight) {
        scrollStatus = "bottom";
      } else {
        var isScrollDown = (y - lastScrollY > 0) ? true : false;
        scrollStatus = isScrollDown ? "down" : "up";
      }

      lastScrollY = y;
      documentElement.setAttribute("data-scroll-status", scrollStatus);
    }

    window.addEventListener('scroll', function(e) {
      storeScrollData();
    });

    storeScrollData();
  }
  document.addEventListener('DOMContentLoaded', initHeader);
</script>
















































































































































<script>
  function hashLocate(hashValue) {
    hashValue = hashValue.replace(/^.*#h-/, '');
    hashValue = decodeURIComponent(hashValue);
    var element = document.getElementById(hashValue);

    if (!element) {
      return;
    }

    var header = document.querySelector('header.site-header');
    var headerRect = header.getBoundingClientRect();
    var headerTop = Math.floor(headerRect.top);
    var headerHeight = Math.floor(headerRect.height);
    var scrollPos = getScrollPos();
    var offsetY = element.offsetTop - (headerTop + headerHeight + 20);

    if (offsetY == scrollPos.y) {
      return;
    }

    if (headerTop == 0  && offsetY > scrollPos.y) {
      offsetY += headerHeight + 2;
    } else if (headerTop < 0  && offsetY < scrollPos.y) {
      offsetY -= headerHeight - 2;
    }

    smoothScrollTo(offsetY);
  }

  // The first event occurred
  window.addEventListener('load', function(event) {
    if (window.location.hash) {
      hashLocate(window.location.hash);
    }
  });

  // The first event occurred
  window.addEventListener('click', function(event) {
    if (event.target.tagName.toLowerCase() == 'a') {
      hashLocate(event.target.getAttribute('href'));
    }
  });
</script>
<div class="theme-toggle">
  <input type="checkbox" id="theme-switch">
  <label for="theme-switch">
    <div class="toggle"></div>
    <div class="names">
      <p class="light">Light</p>
      <p class="dark">Dark</p>
    </div>
  </label>
</div>




<script>
  (function() {
    var sw = document.getElementById('theme-switch');
    var html = document.getElementsByTagName('html')[0];
    var nightModeOption = ('auto' || 'auto').toLowerCase();
    var storage = nightModeOption === 'manual'
        ? localStorage
        : sessionStorage;
    var themeData = loadThemeData();

    function saveThemeData(data) {
      storage.setItem('theme', JSON.stringify(data));
    }

    function loadThemeData() {
      var data = storage.getItem('theme');
      try {
        data = JSON.parse(data ? data : '');
      } catch(e) {
        data = { nightShift: undefined, autoToggleAt: 0 };
        saveThemeData(data);
      }
      return data;
    }

    function handleThemeToggle(nightShift) {
      themeData.nightShift = nightShift;
      saveThemeData(themeData);
      html.dataset.theme = nightShift ? 'dark' : 'light';
      setTimeout(function() {
        sw.checked = nightShift ? true : false;
      }, 50);
    }

    function autoThemeToggle() {
      // Next time point of theme toggle
      var now = new Date();
      var toggleAt = new Date();
      var hours = now.getHours();
      var nightShift = hours >= 19 || hours <=7;

      if (nightShift) {
        if (hours > 7) {
          toggleAt.setDate(toggleAt.getDate() + 1);
        }
        toggleAt.setHours(7);
      } else {
        toggleAt.setHours(19);
      }

      toggleAt.setMinutes(0);
      toggleAt.setSeconds(0);
      toggleAt.setMilliseconds(0)

      var delay = toggleAt.getTime() - now.getTime();

      // auto toggle theme mode
      setTimeout(function() {
        handleThemeToggle(!nightShift);
      }, delay);

      return {
        nightShift: nightShift,
        toggleAt: toggleAt.getTime()
      };
    }

    // Listen the theme toggle event
    sw.addEventListener('change', function(event) {
      handleThemeToggle(event.target.checked);
    });

    if (nightModeOption == 'auto') {
      var data = autoThemeToggle();

      // Toggle theme by local setting
      if (data.toggleAt > themeData.autoToggleAt) {
        themeData.autoToggleAt = data.toggleAt;
        handleThemeToggle(data.nightShift);
      } else {
        handleThemeToggle(themeData.nightShift);
      }
    } else if (nightModeOption == 'manual') {
      handleThemeToggle(themeData.nightShift);
    } else {
      var nightShift = themeData.nightShift;
      if (nightShift === undefined) {
        nightShift = nightModeOption === 'on';
      }
      handleThemeToggle(nightShift);
    }
  })();
</script>
<div id="click-to-top" class="click-to-top">
  <i class="fa fa-arrow-up"></i>
</div>
<script>
  (function () {
    const clickToTop = document.getElementById('click-to-top');
    window.addEventListener('scroll', () => {
      if (window.scrollY > 100) {
        clickToTop.classList.add('show')
      }else {
        clickToTop.classList.remove('show')
      }
    });
    clickToTop.addEventListener('click', () => {
      window.smoothScrollTo(0);
    });
  })();
</script>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="framework">
  <section class="main">

     <div class="post">
  <section>









<header class="post-header">
  <h1 class="post-title p-name" itemprop="name headline">Connection Pooling</h1>
  <h2 class="post-subtitle">In this article we’ll explain what's a connection pool and how this can help the scalability and performance of an application.</h2>

  <p class="post-meta">
    <time class="dt-published" datetime="2021-12-13T00:00:00-03:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Dec 13, 2021
    </time>

    
    
































    <span class="post-reading-time left-vsplit"><i class="fa fa-clock-o"></i> About 8 mins</span>
  </p>
<div class="post-tags">
<a class="post-tag" href="/tags.html#db">#db</a><a class="post-tag" href="/tags.html#postgres">#postgres</a>
</div></header>
<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="post-content e-content" itemprop="articleBody">

      <p>Database connections are fairly expensive operations. Such operation involved the following sequence of steps:</p>

<p>1- Opening a connection to the database using the database driver<br>
2- Opening a TCP socket<br>
3- Execute the SQL query over the socket<br>
4- Closing the connection<br>
5- Closing the socket</p>

<p>In a production environment where we expect thousands of concurrent open and closed connections from clients, the steps explained above for each connection can cause performance to deteriorate, impacting a poor user experience, lost revenue, and even unscheduled downtime. Therefore, the database connections should be kept to a minimum in all possible use cases.</p>

<h2 id="whats-connection-pooling">¿What’s Connection Pooling?</h2>

<p>Connection Pooling is a data access pattern, whose main purpose is to reduce the overhead involved in performing database connections and read/write database operations. It’s a database connection cache implementation which can be configured to suit specific requirements.</p>

<p>The connections pools reuse some existing connection. It prevents the overhead of creating a new connection to the database every time there is a request for a database connection with the same properties (i.e name, database, protocol version). Instead of opening and closing connections for every request, connection pool uses a cache that can be reused when future requests to the database are required. Because traffic is never constant, the connection pool can manage traffic peaks without causing outages.</p>

<h2 id="how-does-connection-pooling-work">¿How does Connection Pooling work?</h2>

<p>A pool contains two types of connections:</p>

<ul>
  <li>
<strong>Active connection</strong>: In use by the application.</li>
  <li>
<strong>Idle connection</strong>:  Available for use by the application.</li>
</ul>

<p>Every time the app gets a connection, the pool creates a new connection only if needed, that is, every connection in the pool is being used (active). Instead, if the pool have connections that are not currently in use (idle), the app will use one of those. The pool keeps a number of connections ready to be used defined by minIdle and maxIdle parameters. When the application close the connection, the pool does not close the physical connection, but becomes idle to be reused. This favors the scalability and performance of an application.</p>

<h2 id="ways-to-integrate-a-connection-pooling">Ways to integrate a Connection Pooling</h2>

<ul>
  <li>
<strong>As external service or middleware</strong>: The connection poolers such as pgbouncer and pgpool-II can be used to pool connections from clients to a  PostgreSQL database. The connection pooler is between the application and the database server.</li>
  <li>
<strong>Client side libraries</strong>: There are libraries that extend the functionality of the database driver to include support for connection pooling.</li>
</ul>

<p>The best way to implement connection pooling for applications is to make use of an external service or middleware, as it is easier to configure and manage. Also, external middleware like pgpool-II provides other features, like load balancing.</p>

<h2 id="parameter-settings">Parameter settings</h2>

<p>Different applications may have different requirements to database connections and you may want to modify the default behavior of connection pooling. Settings such as pool size and connection timeouts can improve the overall performance of the connection pool, as well as connection availability.</p>

<p>In many cases, the best way to tune a connection pool for a specific applications is to try different combinations of the property values until a optimal performance is achieved.</p>

<h3 id="control-pool-size">Control pool size</h3>

<p>The connection pool allows the number of connections to be dynamic as demand increases and decreases. This helps conserve system resources that are otherwise wasted maintaining unnecessary connections.</p>

<h4 id="set-initial-pool-size">Set initial pool size</h4>

<p>Initial pool size specifies the number of available connections that are created when connection pool is initially created o reset.</p>

<p>By default, PostgreSQL has the value zero, which means that there are no previously created connections.</p>

<p>If the initial pool size is greather than the maximum pool size, only the maximum pool size of connections are initialized. In the case that the initial pool size is less than the minimum pool size, only the initial pool size of connections are initialized and held until enough connections are created to meet the minimum pool size value.</p>

<h4 id="set-minimum-pool-size">Set minimum pool size</h4>

<p>Minimum pool size specifies the minimum number of available and borrowed connections that a pool maintains. A connection pool always tries to return to the specified minimum size unless the minimum amount has not yet been reached. For example, if the minimum limit is set to ten and only two connections have been created and borrowed, then the number of connections held by the pool remains two.</p>

<p>By default, PostgreSQL has the value zero.</p>

<h4 id="set-maximum-pool-size">Set maximum pool size</h4>

<p>Maximum pool size specifies the maximum number of connections that a pool maintains. If the maximum number of connections are borrowed, connections will not be available until a connection is returned to the pool.</p>

<p>This property ensures that the pool does not grow to the point of exhausting a system’s resources, which ultimately affects an application’s performance and availability.</p>

<p>A value of zero indicates that there are no connections managed by the pool. An attempt to get a connection result in this situation is an exception.</p>

<h3 id="connection-control">Connection control</h3>

<p>Connections that become stale can affect connection availability. It is necessary to make an effort to close them, because otherwise unused connections for long periods of time can be wasted.</p>

<p>It is good practice to close all connections that are no longer needed by an application. Closing connections help minimize the number of connections that become stale but continue to be borrowed.</p>

<h4 id="maximum-connection-reuse-count">Maximum connection reuse count</h4>

<p>This property specifies the maximum number of times any connection can be reused after which the pool removes and closes a connection. The value must be greater than 0 for this feature to be enabled. For example, if the specified value is 100, then when a connection is reused or borrowed 100 times from the pool, it is closed and removed from the pool. Connections are closed gracefully after they are returned to the pool and the property value has been exceeded.</p>

<p>Default is 0, which means this feature is not enabled.</p>

<h4 id="maximum-connection-reuse-time">Maximum connection reuse time</h4>

<p>This property specifies the maximum time any connection can potentially be reused after which the pool removes and closes a connection. The value is specified in seconds and must be greater than 0. For example, if the specified value is 3600 seconds, then when a connection is in existence for more than 3600 seconds, the connection is closed and removed from the pool. Connections are closed gracefully after they are returned to the pool and the specified property value has been exceeded.</p>

<p>Default is 0, which means this feature is not enabled.</p>

<h4 id="abandoned-connection-timeout">Abandoned connection timeout</h4>

<p>This timeout determines how long a borrowed connection can remain unused before it is considered as abandoned and reclaimed by the connection pool.</p>

<p>Setting the value to 0 disables abandoned connect.</p>

<h4 id="connection-wait-timeout">Connection wait timeout</h4>

<p>This property specifies the amount of time to wait for a used connection to be released by a client. This only applies when the maximum number of connections has been borrowed from the connection pool. When a client tries to borrow a connection from the pool and all connections are in use, the connection pool waits for a connection to be released back to the pool.</p>

<h4 id="innactive-connection-timeout">Innactive connection timeout</h4>

<p>This timeout determines how long an available connection remains in the connection pool before it is removed from the pool.</p>

<p>Setting the value to 0 disables inactive connection timeout processing.</p>

<h2 id="sources">Sources</h2>

<ul>
  <li><a href="http://www.juntadeandalucia.es/servicios/madeja/contenido/recurso/218">Manejo del pool de conexiones</a></li>
  <li><a href="https://es.stackoverflow.com/questions/46754/pool-de-conexiones-java">Pool de Conexiones Java</a></li>
  <li><a href="https://es.stackoverflow.com/questions/359715/cu%C3%A1l-ser%C3%ADa-la-diferencia-entre-usar-un-pool-o-usar-una-conexion-tradicional-a-l">¿cuál sería la diferencia entre usar un pool o usar una conexion tradicional a la base de datos?</a></li>
  <li><a href="https://www.baeldung.com/java-connection-pooling">A Simple Guide to Connection Pooling in Java</a></li>
  <li><a href="https://stackoverflow.blog/2020/10/14/improve-database-performance-with-connection-pooling/">Improve database performance with connection pooling</a></li>
  <li><a href="https://stackoverflow.com/questions/18496540/node-js-mysql-connection-pooling/54224377#54224377">node.js + mysql connection pooling</a></li>
  <li><a href="https://docs.oracle.com/cd/E11882_01/java.112/e12826/oracle/ucp/jdbc/PoolDataSource.html">Oracle Universal Connection Pool for JDBC Java API Reference
11g Release 2 (11.2)</a></li>
</ul>


    </div>

</article>
<div class="post-nav">
<a class="previous" href="/docker/2021/12/02/docker-limit-resources.html" title="How to set Docker Resources Limit">How to set Docker Resources Limit...</a><a class="next" href="/postgres/2021/12/18/postgresql-too-many-clients.html" title="Sorry, too many clients already - error PostgreSQL">Sorry, too many clients already -...</a>
</div>
<div class="post-related">
      <div>Related Articles</div>
      <ul>
        <li><a class="post-link" href="/docker/2021/12/02/docker-limit-resources.html" title="Sorry, too many clients already - error PostgreSQL">How to set Docker Resources Limit</a></li>
<li><a class="post-link" href="/docker/2022/01/08/https-con-docker-y-apache.html" title="Sorry, too many clients already - error PostgreSQL">HTTPS with Docker and Apache</a></li>
<li><a class="post-link" href="/react/2022/04/15/better-react-code.html" title="Sorry, too many clients already - error PostgreSQL">Better React code</a></li>
<li><a class="post-link" href="/docker/2022/03/16/uid-y-gid-en-Docker.html" title="Sorry, too many clients already - error PostgreSQL">UID/GID in Docker</a></li>
</ul>
    </div>
<div class="post-comments"></div></section>
</div>


  </section>
  <section class="sidebar" style="margin-left: 15px;">
    <!-- Get sidebar items --><style type="text/css" media="screen">
.post-menu ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
</style>

<div class="post-menu">
  <div class="post-menu-title">TOC</div>
  <div class="post-menu-content"></div>
</div>

<script>
  function generateContent() {
    var menu = document.querySelector(".post-menu");
    var menuContent =  menu.querySelector(".post-menu-content");
    var headings = document.querySelector(".post-content").querySelectorAll("h2, h3, h4, h5, h6");

    // Hide menu when no headings
    if (headings.length === 0) {
      return menu.style.display = "none";
    }

    // Generate post menu
    var menuHTML = '';
    for (var i = 0; i < headings.length; i++) {
      var h = headings[i];
      menuHTML += (
        '<li class="h-' + h.tagName.toLowerCase() + '">'
        + '<a href="#h-' + h.getAttribute('id') + '">' + h.textContent + '</a></li>');
    }

    menuContent.innerHTML = '<ul>' + menuHTML + '</ul>';

    // The header element
    var header = document.querySelector('header.site-header');

    function doMenuCollapse(index, over_items) {
      var items = menuContent.firstChild.children;

      if (over_items == undefined) {
        over_items = 20;
      }

      if (items.length < over_items) {
        return;
      }

      var activeItem = items[index];
      var beginItem = activeItem
      var endItem = activeItem
      var beginIndex = index;
      var endIndex = index + 1;
      while (beginIndex >= 0
        && !items[beginIndex].classList.contains('h-h2')) {
        beginIndex -= 1;
      }
      while (endIndex < items.length
        && !items[endIndex].classList.contains('h-h2')) {
        endIndex += 1;
      }
      for (var i = 0; i < beginIndex; i++) {
        item = items[i]
        if (!item.classList.contains('h-h2')) {
          item.style.display = 'none';
        }
      }
      for (var i = beginIndex + 1; i < endIndex; i++) {
        item = items[i]
        // if (!item.classList.contains('h-h2')) {
          item.style.display = '';
        // }
      }
      for (var i = endIndex; i < items.length; i++) {
        item = items[i]
        if (!item.classList.contains('h-h2')) {
          item.style.display = 'none';
        }
      }
    }

    // Init menu collapsed
    doMenuCollapse(-1);

    // Active the menu item
    window.addEventListener('scroll', function (event) {
      var lastActive = menuContent.querySelector('.active');
      var changed = true;
      var activeIndex = -1;
      for (var i = headings.length - 1; i >= 0; i--) {
        var h = headings[i];
        var headingRect = h.getBoundingClientRect();
        var headerRect = header.getBoundingClientRect();
        var headerTop = Math.floor(headerRect.top);
        var headerHeight = Math.floor(headerRect.height);
        var headerHeight = headerTop + headerHeight + 20;
        if (headingRect.top <= headerHeight) {
          var id = 'h-' + h.getAttribute('id');
          var a = menuContent.querySelector('a[href="#' + id  + '"]');
          var curActive = a.parentNode;
          if (curActive) {
            curActive.classList.add('active');
            activeIndex = i;
          }
          if (lastActive == curActive) {
            changed = false;
          }
          break;
        }
      }
      if (changed) {
        if (lastActive) {
          lastActive.classList.remove('active');
        }
        doMenuCollapse(activeIndex);
      }
      event.preventDefault();
    });
  }
  generateContent();
</script>
</section>
</div>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">
    <div class="site-footer-inner">
<div>All rights reserved <span class="copyleft">©</span> Eva Villarreal Guzmán 2022 </div>
      <div>Powered by <a title="Jekyll is a simple, blog-aware, static site
      generator." href="https://jekyllrb.com/">Jekyll</a> &amp; <a title="Yat, yet
      another theme." href="https://github.com/jeffreytse/jekyll-theme-yat">Yat Theme</a>.</div>
    </div>
  </div>
</footer>
</body>
</html>
