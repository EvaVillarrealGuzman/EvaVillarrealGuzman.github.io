<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-translate-customization" content="108d9124921d80c3-80e20d618ff053c8-g4f02ec6f3dba68b7-c">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Sorry, too many clients already - error PostgreSQL | Eva Villarreal Guzmán</title>
<meta name="generator" content="Jekyll v4.2.2">
<meta property="og:title" content="Sorry, too many clients already - error PostgreSQL">
<meta name="author" content="Eva Villarreal Guzmán">
<meta property="og:locale" content="en_US">
<meta name="description" content="The max_connections parameter determines the maximun number of simultaneous connections that the database server can handle. By default, PostgreSQL sets this parameter to 100.">
<meta property="og:description" content="The max_connections parameter determines the maximun number of simultaneous connections that the database server can handle. By default, PostgreSQL sets this parameter to 100.">
<link rel="canonical" href="http://localhost:4000/postgres/2021/12/18/postgresql-too-many-clients.html">
<meta property="og:url" content="http://localhost:4000/postgres/2021/12/18/postgresql-too-many-clients.html">
<meta property="og:site_name" content="Eva Villarreal Guzmán">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2021-12-18T00:00:00-03:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="Sorry, too many clients already - error PostgreSQL">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Eva Villarreal Guzmán"},"dateModified":"2021-12-18T00:00:00-03:00","datePublished":"2021-12-18T00:00:00-03:00","description":"The max_connections parameter determines the maximun number of simultaneous connections that the database server can handle. By default, PostgreSQL sets this parameter to 100.","headline":"Sorry, too many clients already - error PostgreSQL","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/postgres/2021/12/18/postgresql-too-many-clients.html"},"url":"http://localhost:4000/postgres/2021/12/18/postgresql-too-many-clients.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="shortcut icon" href="">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-noto-sans@0.0.72/index.min.css">
  <link rel="stylesheet" href="/assets/css/main.css">
  <script src="/assets/js/main.js"></script><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Eva Villarreal Guzmán">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
<!-- and it's easy to individually load additional languages -->
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/go.min.js"></script>



















<script>
// Init highlight js
document.addEventListener('DOMContentLoaded', function(event) {
  var els = document.querySelectorAll('pre code')

  function addLangData(block) {
    var outer = block.parentElement.parentElement.parentElement;
    var lang = block.getAttribute('data-lang');
    for (var i = 0; i < outer.classList.length; i++) {
      var cls = outer.classList[i];
      if (cls.startsWith('language-')) {
        lang = cls;
        break;
      }
    }
    if (!lang) {
      cls = block.getAttribute('class');
      lang = cls ? cls.replace('hljs ', '') : '';
    }
    if (lang.startsWith('language-')) {
      lang = lang.substr(9);
    }
    block.setAttribute('class', 'hljs ' + lang);
    block.parentNode.setAttribute('data-lang', lang);
  }

  function addBadge(block) {
    var enabled = ('true' || 'true').toLowerCase();
    if (enabled == 'true') {
      var pre = block.parentElement;
      pre.classList.add('badge');
    }
  }

  function handle(block) {
    addLangData(block);
    addBadge(block)
    hljs.highlightBlock(block);
  }

  for (var i = 0; i < els.length; i++) {
    var el = els[i];
    handle(el);
  }
});
</script>

<style>
  /* code language badge */
  pre.badge::before {
    content: attr(data-lang);
    color: #fff;
    background-color: #ff4e00;
    padding: 0 .5em;
    border-radius: 0 2px;
    text-transform: uppercase;
    text-align: center;
    min-width: 32px;
    display: inline-block;
    position: absolute;
    right: 0;
  }

  /* fix wrong badge display for firefox browser */
  code > table pre::before {
    display: none;
  }
</style>
</head>
<body>



























































































































<header class="site-header " role="banner">

  <div class="wrapper">
    <div class="site-header-inner">
<span class="site-brand"><a class="site-brand-inner" rel="author" href="/">
  <img class="site-favicon" title="Eva Villarreal Guzmán" src="" onerror="this.style.display='none'">
  Eva Villarreal Guzmán
</a>
</span><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger">
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewbox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
              </svg>
            </span>
          </label>

          <div class="trigger">
<a class="page-link" href="/about.html">ABOUT</a><a class="page-link" href="/archives.html">ARCHIVES</a><a class="page-link" href="/categories.html">CATEGORIES</a><a class="page-link" href="/">HOME</a><a class="page-link" href="/tags.html">TAGS</a>









<span class="page-link">



<div id="google_translate_element" style="display: none;">
</div>

<span class="ct-language">
  <ul class="list-unstyled ct-language-dropdown">
    
      <li>
        <a href="#" class="lang-select" data-lang="en">
          
          <img src="https://cdn.countryflags.com/thumbs/united-states-of-america/flag-400.png" title="English">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="es">
          
          <img src="https://cdn.countryflags.com/thumbs/spain/flag-400.png" title="Spanish">
          
        </a>
      </li>
    
  </ul>
</span>

<script type="text/javascript">
function googleTranslateElementInit() {
  new google.translate.TranslateElement({
    pageLanguage: 'en',
    autoDisplay: false,
    layout: google.translate.TranslateElement.InlineLayout.VERTICAL
  }, 'google_translate_element');

  // Links to cross-origin destinations are unsafe
  var gll = document.getElementsByClassName('goog-logo-link')[0];
  if (gll) {
    gll.setAttribute('rel', 'noopener');
  }

  function restoreLang() {
    var iframe = document.getElementsByClassName('goog-te-banner-frame')[0];
    if (!iframe) return;

    var innerDoc = iframe.contentDocument || iframe.contentWindow.document;
    var restore_el = innerDoc.getElementsByTagName("button");

    for (var i = 0; i < restore_el.length; i++) {
      if (restore_el[i].id.indexOf("restore") >= 0) {
        restore_el[i].click();
        var close_el = innerDoc.getElementsByClassName("goog-close-link");
        close_el[0].click();
        return;
      }
    }
  }

  function triggerHtmlEvent(element, eventName) {
    var event;
    if (document.createEvent) {
      event = document.createEvent('HTMLEvents');
      event.initEvent(eventName, true, true);
      element.dispatchEvent(event);
    } else {
      event = document.createEventObject();
      event.eventType = eventName;
      element.fireEvent('on' + event.eventType, event);
    }
  }

  var googleCombo = document.querySelector("select.goog-te-combo");
  var langSelect = document.querySelector('.ct-language');
  langSelect.addEventListener('click', function(event) {
    if (!event.target) {
      return;
    }

    var selected = document.querySelector('.ct-language .ct-language-selected');
    if (selected) {
      selected.classList.remove('ct-language-selected');
    }

    var target = event.target;
    while (target && target !== langSelect ) {
      if (target.matches('.lang-select')) {
        break;
      }
      target = target.parentElement;
    }

    if (target && target.matches('.lang-select')) {
      var lang = target.getAttribute('data-lang');
      if (googleCombo.value == lang) {
        restoreLang();
      } else {
        target.parentElement.classList.add('ct-language-selected');
        googleCombo.value = lang;
        triggerHtmlEvent(googleCombo, 'change');
      }
    }

    event.preventDefault();
  });
}
</script>

<script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
</span>
</div>
        </nav>
</div>
  </div>
</header>

<script>
  function initHeader() {
    var lastScrollY = getScrollPos().y;
    var documentElement = document.documentElement;

    function storeScrollData() {
      var y = getScrollPos().y;var scrollStatus = "";

      if (y <= 0) {
        scrollStatus = "top";
      } else if ((window.innerHeight + y) >= document.body.offsetHeight) {
        scrollStatus = "bottom";
      } else {
        var isScrollDown = (y - lastScrollY > 0) ? true : false;
        scrollStatus = isScrollDown ? "down" : "up";
      }

      lastScrollY = y;
      documentElement.setAttribute("data-scroll-status", scrollStatus);
    }

    window.addEventListener('scroll', function(e) {
      storeScrollData();
    });

    storeScrollData();
  }
  document.addEventListener('DOMContentLoaded', initHeader);
</script>
















































































































































<script>
  function hashLocate(hashValue) {
    hashValue = hashValue.replace(/^.*#h-/, '');
    hashValue = decodeURIComponent(hashValue);
    var element = document.getElementById(hashValue);

    if (!element) {
      return;
    }

    var header = document.querySelector('header.site-header');
    var headerRect = header.getBoundingClientRect();
    var headerTop = Math.floor(headerRect.top);
    var headerHeight = Math.floor(headerRect.height);
    var scrollPos = getScrollPos();
    var offsetY = element.offsetTop - (headerTop + headerHeight + 20);

    if (offsetY == scrollPos.y) {
      return;
    }

    if (headerTop == 0  && offsetY > scrollPos.y) {
      offsetY += headerHeight + 2;
    } else if (headerTop < 0  && offsetY < scrollPos.y) {
      offsetY -= headerHeight - 2;
    }

    smoothScrollTo(offsetY);
  }

  // The first event occurred
  window.addEventListener('load', function(event) {
    if (window.location.hash) {
      hashLocate(window.location.hash);
    }
  });

  // The first event occurred
  window.addEventListener('click', function(event) {
    if (event.target.tagName.toLowerCase() == 'a') {
      hashLocate(event.target.getAttribute('href'));
    }
  });
</script>
<div class="theme-toggle">
  <input type="checkbox" id="theme-switch">
  <label for="theme-switch">
    <div class="toggle"></div>
    <div class="names">
      <p class="light">Light</p>
      <p class="dark">Dark</p>
    </div>
  </label>
</div>




<script>
  (function() {
    var sw = document.getElementById('theme-switch');
    var html = document.getElementsByTagName('html')[0];
    var nightModeOption = ('auto' || 'auto').toLowerCase();
    var storage = nightModeOption === 'manual'
        ? localStorage
        : sessionStorage;
    var themeData = loadThemeData();

    function saveThemeData(data) {
      storage.setItem('theme', JSON.stringify(data));
    }

    function loadThemeData() {
      var data = storage.getItem('theme');
      try {
        data = JSON.parse(data ? data : '');
      } catch(e) {
        data = { nightShift: undefined, autoToggleAt: 0 };
        saveThemeData(data);
      }
      return data;
    }

    function handleThemeToggle(nightShift) {
      themeData.nightShift = nightShift;
      saveThemeData(themeData);
      html.dataset.theme = nightShift ? 'dark' : 'light';
      setTimeout(function() {
        sw.checked = nightShift ? true : false;
      }, 50);
    }

    function autoThemeToggle() {
      // Next time point of theme toggle
      var now = new Date();
      var toggleAt = new Date();
      var hours = now.getHours();
      var nightShift = hours >= 19 || hours <=7;

      if (nightShift) {
        if (hours > 7) {
          toggleAt.setDate(toggleAt.getDate() + 1);
        }
        toggleAt.setHours(7);
      } else {
        toggleAt.setHours(19);
      }

      toggleAt.setMinutes(0);
      toggleAt.setSeconds(0);
      toggleAt.setMilliseconds(0)

      var delay = toggleAt.getTime() - now.getTime();

      // auto toggle theme mode
      setTimeout(function() {
        handleThemeToggle(!nightShift);
      }, delay);

      return {
        nightShift: nightShift,
        toggleAt: toggleAt.getTime()
      };
    }

    // Listen the theme toggle event
    sw.addEventListener('change', function(event) {
      handleThemeToggle(event.target.checked);
    });

    if (nightModeOption == 'auto') {
      var data = autoThemeToggle();

      // Toggle theme by local setting
      if (data.toggleAt > themeData.autoToggleAt) {
        themeData.autoToggleAt = data.toggleAt;
        handleThemeToggle(data.nightShift);
      } else {
        handleThemeToggle(themeData.nightShift);
      }
    } else if (nightModeOption == 'manual') {
      handleThemeToggle(themeData.nightShift);
    } else {
      var nightShift = themeData.nightShift;
      if (nightShift === undefined) {
        nightShift = nightModeOption === 'on';
      }
      handleThemeToggle(nightShift);
    }
  })();
</script>
<div id="click-to-top" class="click-to-top">
  <i class="fa fa-arrow-up"></i>
</div>
<script>
  (function () {
    const clickToTop = document.getElementById('click-to-top');
    window.addEventListener('scroll', () => {
      if (window.scrollY > 100) {
        clickToTop.classList.add('show')
      }else {
        clickToTop.classList.remove('show')
      }
    });
    clickToTop.addEventListener('click', () => {
      window.smoothScrollTo(0);
    });
  })();
</script>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="framework">
  <section class="main">

     <div class="post">
  <section>









<header class="post-header">
  <h1 class="post-title p-name" itemprop="name headline">Sorry, too many clients already - error PostgreSQL</h1>
  <h2 class="post-subtitle">In this article we’ll see different strategies to solve this error, how to perform one of them and commands will be useful to analyze this type of error</h2>

  <p class="post-meta">
    <time class="dt-published" datetime="2021-12-18T00:00:00-03:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Dec 18, 2021
    </time>

    
    
































    <span class="post-reading-time left-vsplit"><i class="fa fa-clock-o"></i> About 4 mins</span>
  </p>
<div class="post-tags">
<a class="post-tag" href="/tags.html#db">#db</a><a class="post-tag" href="/tags.html#postgres">#postgres</a>
</div></header>
<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="post-content e-content" itemprop="articleBody">

      <p>The <code class="language-plaintext highlighter-rouge">max_connections</code> parameter determines the maximun number of simultaneous connections that the database server can handle. By default, PostgreSQL sets this parameter to 100.</p>

<p>When this limit is exceeded, PostgreSQL will throw the next exception:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>org.postgresql.util.PSQLException: FATAL: sorry, too many clients already.
</code></pre></div></div>
<h2 id="solutions">Solutions</h2>

<p>Faced with this error, we can find the following solutions:</p>

<ol>
  <li>Increase the <code class="language-plaintext highlighter-rouge">max_connections</code> parameter. This is the most easiest one, but probably will work as a temporary solution.</li>
  <li>Ensure that applications close the connection to the database. To help you find the applications that isn’t closing the connection, you could give different usernames/passwords to each application that might not releasing the connections, and then, with <code class="language-plaintext highlighter-rouge">pg_stat_activity</code> you can find out the application that is not closing.</li>
  <li>Use a connection pool in applications. A connection pool keeps a number of open connections to the database. In this way, the application, instead of opening a new connection, can use one of those available in the pool, improvement the performance of the application because open and close connections in database incur a processor cost. For more detail see <a href="/Connections-pool">here</a>.</li>
</ol>

<p>Particularly in this post we are going to focus on the solution 1, that is, the configuration of <code class="language-plaintext highlighter-rouge">max_connections</code> parameter.</p>

<p>About this parameter, you have in mind the following:</p>

<blockquote>
  <p>Each PostgreSQL connection consumes RAM for managing the connection or the client using it. The more connections you have, the more RAM you will be using that could instead be used to run the database.</p>
</blockquote>

<p>Typically, a well-written application doesn’t need a large number of connections. If you have an application that needs a large number of connections, then consider using a tool which can pool connections. As each connection consumes RAM, you should be looking to minimize their use.</p>

<h2 id="useful-command-to-see-the-connections-in-the-database">Useful command to see the connections in the database</h2>

<h3 id="check-the-current-value-of-the-parameter">Check the current value of the parameter</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SHOW</span> <span class="n">max_connections</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="see-in-detail-the-currently-used-connections">See in detail the currently used connections</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">pg_stat_activity</span><span class="p">;</span>
</code></pre></div></div>

<p>This command allow you see who/what/where/when is holding open your connections.</p>

<h3 id="get-the-number-of-connections-currently-used">Get the number of connections currently used</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">pg_stat_activity</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="edit-max_connections-parameter">Edit max_connections parameter</h2>

<p>Just increasing <code class="language-plaintext highlighter-rouge">max_connections</code> is bad idea. You need to increase <code class="language-plaintext highlighter-rouge">shared_buffers</code> and <code class="language-plaintext highlighter-rouge">kernel.shmmax</code> as well. <code class="language-plaintext highlighter-rouge">max_connections</code> and <code class="language-plaintext highlighter-rouge">shared_buffers</code> are PostgreSQL parameters and <code class="language-plaintext highlighter-rouge">kernel.shmmax</code> is a kernel parameter.</p>

<p>The <code class="language-plaintext highlighter-rouge">shared_buffers</code> parameter determines how much memory is dedicated to PostgreSQL to use for caching data.</p>

<p>You can following the next rules to configure <code class="language-plaintext highlighter-rouge">max_connections</code>, <code class="language-plaintext highlighter-rouge">shared_buffers</code> and <code class="language-plaintext highlighter-rouge">kernel.shmmax</code> parameters:</p>

<ul>
  <li>If you have a server with 1 GB or more of RAM, a reasonable initial value for  <code class="language-plaintext highlighter-rouge">shared_buffers</code> is 25% of the memory of your server.</li>
  <li>It’s unlikely you’ll find using more than 40% of RAM to work better than a smaller amount (like 25%).</li>
  <li>Be aware that if your server or PostgreSQL build is 32-bit, it might not be practical to set <code class="language-plaintext highlighter-rouge">shared_buffers</code> above 2 ~ 2.5GB.</li>
</ul>

<p>To edit these parameters, first find the location of the PostgreSQL config file:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SHOW</span> <span class="n">config_file</span><span class="p">;</span>
</code></pre></div></div>

<p>Open the PostgreSQL config file  and update the <code class="language-plaintext highlighter-rouge">max_connections</code> and <code class="language-plaintext highlighter-rouge">shared_buffers</code> parameters. For example, if you have a server with 8 GB of memory edit the value of <code class="language-plaintext highlighter-rouge">shared_buffers</code> parameter to 2 GB (25%) in <code class="language-plaintext highlighter-rouge">postgresql.conf</code> file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>max_connections = 100
shared_buffers = 2GB
</code></pre></div></div>

<p>Restart the PostgreSQL service:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl restart postgresql
</code></pre></div></div>

<p>You should increase kernel max segment size to be slightly larger than the <code class="language-plaintext highlighter-rouge">shared_buffers</code>. In the file <code class="language-plaintext highlighter-rouge">/etc/sysctl.conf</code>, set the <code class="language-plaintext highlighter-rouge">kernel.shmmax</code> parameter as following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kernel.shmmax=2469606195
</code></pre></div></div>

<p>It will take effect when PostgreSQL reboots. This line makes the kernel have a maximun of  2.3 GB.</p>

<p>On modern systems, <code class="language-plaintext highlighter-rouge">kernel.shmmax</code> it’s already set high and should not be changed. To check the value that is setting in your system, you can run the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> /proc/sys/kernel/shmmax
</code></pre></div></div>

<blockquote>
  <p><strong>Note:</strong> You can use the page <a href="https://pgtune.leopard.in.ua/">PGTune</a> to get the optimal parameters for your system.</p>
</blockquote>

<h2 id="sources">Sources</h2>

<ul>
  <li><a href="https://stackoverflow.com/questions/2757549/org-postgresql-util-psqlexception-fatal-sorry-too-many-clients-already">org.postgresql.util.PSQLException: FATAL: sorry, too many clients already</a></li>
  <li><a href="https://dadruid5.com/2017/07/20/checking-and-increasing-the-max-connections-in-postgresql/">Checking and Increasing the Connection Limit in PostgreSQL</a></li>
  <li><a href="https://devcoops.com/resolve-sorry-too-many-clients-postgres-issue/">How to resolve PostgreSQL FATAL: sorry, too many clients already</a></li>
  <li><a href="https://stackoverflow.com/questions/30778015/how-to-increase-the-max-connections-in-postgres">How to increase the max connections in postgres?</a></li>
</ul>


    </div>

</article>
<div class="post-nav">
<a class="previous" href="/postgres/2021/12/13/connections-pool.html" title="Connection Pooling">Connection Pooling</a><a class="next" href="/docker/2022/01/08/https-con-docker-y-apache.html" title="HTTPS with Docker and Apache">HTTPS with Docker and Apache</a>
</div>
<div class="post-related">
      <div>Related Articles</div>
      <ul>
        <li><a class="post-link" href="/docker/2021/12/02/docker-limit-resources.html" title="HTTPS with Docker and Apache">How to set Docker Resources Limit</a></li>
<li><a class="post-link" href="/docker/2022/01/08/https-con-docker-y-apache.html" title="HTTPS with Docker and Apache">HTTPS with Docker and Apache</a></li>
<li><a class="post-link" href="/postgres/2021/12/13/connections-pool.html" title="HTTPS with Docker and Apache">Connection Pooling</a></li>
<li><a class="post-link" href="/postgres/2021/12/18/postgresql-too-many-clients.html" title="HTTPS with Docker and Apache">Sorry, too many clients already - error PostgreSQL</a></li>
</ul>
    </div>
<div class="post-comments"></div></section>
</div>


  </section>
  <section class="sidebar" style="margin-left: 15px;">
    <!-- Get sidebar items --><style type="text/css" media="screen">
.post-menu ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
</style>

<div class="post-menu">
  <div class="post-menu-title">TOC</div>
  <div class="post-menu-content"></div>
</div>

<script>
  function generateContent() {
    var menu = document.querySelector(".post-menu");
    var menuContent =  menu.querySelector(".post-menu-content");
    var headings = document.querySelector(".post-content").querySelectorAll("h2, h3, h4, h5, h6");

    // Hide menu when no headings
    if (headings.length === 0) {
      return menu.style.display = "none";
    }

    // Generate post menu
    var menuHTML = '';
    for (var i = 0; i < headings.length; i++) {
      var h = headings[i];
      menuHTML += (
        '<li class="h-' + h.tagName.toLowerCase() + '">'
        + '<a href="#h-' + h.getAttribute('id') + '">' + h.textContent + '</a></li>');
    }

    menuContent.innerHTML = '<ul>' + menuHTML + '</ul>';

    // The header element
    var header = document.querySelector('header.site-header');

    function doMenuCollapse(index, over_items) {
      var items = menuContent.firstChild.children;

      if (over_items == undefined) {
        over_items = 20;
      }

      if (items.length < over_items) {
        return;
      }

      var activeItem = items[index];
      var beginItem = activeItem
      var endItem = activeItem
      var beginIndex = index;
      var endIndex = index + 1;
      while (beginIndex >= 0
        && !items[beginIndex].classList.contains('h-h2')) {
        beginIndex -= 1;
      }
      while (endIndex < items.length
        && !items[endIndex].classList.contains('h-h2')) {
        endIndex += 1;
      }
      for (var i = 0; i < beginIndex; i++) {
        item = items[i]
        if (!item.classList.contains('h-h2')) {
          item.style.display = 'none';
        }
      }
      for (var i = beginIndex + 1; i < endIndex; i++) {
        item = items[i]
        // if (!item.classList.contains('h-h2')) {
          item.style.display = '';
        // }
      }
      for (var i = endIndex; i < items.length; i++) {
        item = items[i]
        if (!item.classList.contains('h-h2')) {
          item.style.display = 'none';
        }
      }
    }

    // Init menu collapsed
    doMenuCollapse(-1);

    // Active the menu item
    window.addEventListener('scroll', function (event) {
      var lastActive = menuContent.querySelector('.active');
      var changed = true;
      var activeIndex = -1;
      for (var i = headings.length - 1; i >= 0; i--) {
        var h = headings[i];
        var headingRect = h.getBoundingClientRect();
        var headerRect = header.getBoundingClientRect();
        var headerTop = Math.floor(headerRect.top);
        var headerHeight = Math.floor(headerRect.height);
        var headerHeight = headerTop + headerHeight + 20;
        if (headingRect.top <= headerHeight) {
          var id = 'h-' + h.getAttribute('id');
          var a = menuContent.querySelector('a[href="#' + id  + '"]');
          var curActive = a.parentNode;
          if (curActive) {
            curActive.classList.add('active');
            activeIndex = i;
          }
          if (lastActive == curActive) {
            changed = false;
          }
          break;
        }
      }
      if (changed) {
        if (lastActive) {
          lastActive.classList.remove('active');
        }
        doMenuCollapse(activeIndex);
      }
      event.preventDefault();
    });
  }
  generateContent();
</script>
</section>
</div>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">
    <div class="site-footer-inner">
<div>All rights reserved <span class="copyleft">©</span> Eva Villarreal Guzmán 2022 </div>
      <div>Powered by <a title="Jekyll is a simple, blog-aware, static site
      generator." href="https://jekyllrb.com/">Jekyll</a> &amp; <a title="Yat, yet
      another theme." href="https://github.com/jeffreytse/jekyll-theme-yat">Yat Theme</a>.</div>
    </div>
  </div>
</footer>
</body>
</html>
