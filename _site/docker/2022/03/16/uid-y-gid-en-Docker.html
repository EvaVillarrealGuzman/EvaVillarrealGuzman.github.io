<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-translate-customization" content="108d9124921d80c3-80e20d618ff053c8-g4f02ec6f3dba68b7-c">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>UID/GID in Docker | Eva Villarreal Guzmán</title>
<meta name="generator" content="Jekyll v4.2.2">
<meta property="og:title" content="UID/GID in Docker">
<meta name="author" content="Eva Villarreal Guzmán">
<meta property="og:locale" content="en_US">
<meta name="description" content="When you are using Docker in development environment and you use some tool that generates files during development, such as dependecies managment (e.g. npm, composer) or to compile task (e.g. SCSS to CSS), if you try to delete or modify these files generated by the tool, maybe you will find with permission denied.">
<meta property="og:description" content="When you are using Docker in development environment and you use some tool that generates files during development, such as dependecies managment (e.g. npm, composer) or to compile task (e.g. SCSS to CSS), if you try to delete or modify these files generated by the tool, maybe you will find with permission denied.">
<link rel="canonical" href="http://localhost:4000/docker/2022/03/16/uid-y-gid-en-Docker.html">
<meta property="og:url" content="http://localhost:4000/docker/2022/03/16/uid-y-gid-en-Docker.html">
<meta property="og:site_name" content="Eva Villarreal Guzmán">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2022-03-16T00:00:00-03:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="UID/GID in Docker">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Eva Villarreal Guzmán"},"dateModified":"2022-03-16T00:00:00-03:00","datePublished":"2022-03-16T00:00:00-03:00","description":"When you are using Docker in development environment and you use some tool that generates files during development, such as dependecies managment (e.g. npm, composer) or to compile task (e.g. SCSS to CSS), if you try to delete or modify these files generated by the tool, maybe you will find with permission denied.","headline":"UID/GID in Docker","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/docker/2022/03/16/uid-y-gid-en-Docker.html"},"url":"http://localhost:4000/docker/2022/03/16/uid-y-gid-en-Docker.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="shortcut icon" href="">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-noto-sans@0.0.72/index.min.css">
  <link rel="stylesheet" href="/assets/css/main.css">
  <script src="/assets/js/main.js"></script><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Eva Villarreal Guzmán">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
<!-- and it's easy to individually load additional languages -->
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/go.min.js"></script>



















<script>
// Init highlight js
document.addEventListener('DOMContentLoaded', function(event) {
  var els = document.querySelectorAll('pre code')

  function addLangData(block) {
    var outer = block.parentElement.parentElement.parentElement;
    var lang = block.getAttribute('data-lang');
    for (var i = 0; i < outer.classList.length; i++) {
      var cls = outer.classList[i];
      if (cls.startsWith('language-')) {
        lang = cls;
        break;
      }
    }
    if (!lang) {
      cls = block.getAttribute('class');
      lang = cls ? cls.replace('hljs ', '') : '';
    }
    if (lang.startsWith('language-')) {
      lang = lang.substr(9);
    }
    block.setAttribute('class', 'hljs ' + lang);
    block.parentNode.setAttribute('data-lang', lang);
  }

  function addBadge(block) {
    var enabled = ('true' || 'true').toLowerCase();
    if (enabled == 'true') {
      var pre = block.parentElement;
      pre.classList.add('badge');
    }
  }

  function handle(block) {
    addLangData(block);
    addBadge(block)
    hljs.highlightBlock(block);
  }

  for (var i = 0; i < els.length; i++) {
    var el = els[i];
    handle(el);
  }
});
</script>

<style>
  /* code language badge */
  pre.badge::before {
    content: attr(data-lang);
    color: #fff;
    background-color: #ff4e00;
    padding: 0 .5em;
    border-radius: 0 2px;
    text-transform: uppercase;
    text-align: center;
    min-width: 32px;
    display: inline-block;
    position: absolute;
    right: 0;
  }

  /* fix wrong badge display for firefox browser */
  code > table pre::before {
    display: none;
  }
</style>
</head>
<body>



























































































































<header class="site-header " role="banner">

  <div class="wrapper">
    <div class="site-header-inner">
<span class="site-brand"><a class="site-brand-inner" rel="author" href="/">
  <img class="site-favicon" title="Eva Villarreal Guzmán" src="" onerror="this.style.display='none'">
  Eva Villarreal Guzmán
</a>
</span><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger">
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewbox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
              </svg>
            </span>
          </label>

          <div class="trigger">
<a class="page-link" href="/about.html">ABOUT</a><a class="page-link" href="/archives.html">ARCHIVES</a><a class="page-link" href="/categories.html">CATEGORIES</a><a class="page-link" href="/">HOME</a><a class="page-link" href="/tags.html">TAGS</a>









<span class="page-link">



<div id="google_translate_element" style="display: none;">
</div>

<span class="ct-language">
  <ul class="list-unstyled ct-language-dropdown">
    
      <li>
        <a href="#" class="lang-select" data-lang="en">
          
          <img src="https://cdn.countryflags.com/thumbs/united-states-of-america/flag-400.png" title="English">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="es">
          
          <img src="https://cdn.countryflags.com/thumbs/spain/flag-400.png" title="Spanish">
          
        </a>
      </li>
    
  </ul>
</span>

<script type="text/javascript">
function googleTranslateElementInit() {
  new google.translate.TranslateElement({
    pageLanguage: 'en',
    autoDisplay: false,
    layout: google.translate.TranslateElement.InlineLayout.VERTICAL
  }, 'google_translate_element');

  // Links to cross-origin destinations are unsafe
  var gll = document.getElementsByClassName('goog-logo-link')[0];
  if (gll) {
    gll.setAttribute('rel', 'noopener');
  }

  function restoreLang() {
    var iframe = document.getElementsByClassName('goog-te-banner-frame')[0];
    if (!iframe) return;

    var innerDoc = iframe.contentDocument || iframe.contentWindow.document;
    var restore_el = innerDoc.getElementsByTagName("button");

    for (var i = 0; i < restore_el.length; i++) {
      if (restore_el[i].id.indexOf("restore") >= 0) {
        restore_el[i].click();
        var close_el = innerDoc.getElementsByClassName("goog-close-link");
        close_el[0].click();
        return;
      }
    }
  }

  function triggerHtmlEvent(element, eventName) {
    var event;
    if (document.createEvent) {
      event = document.createEvent('HTMLEvents');
      event.initEvent(eventName, true, true);
      element.dispatchEvent(event);
    } else {
      event = document.createEventObject();
      event.eventType = eventName;
      element.fireEvent('on' + event.eventType, event);
    }
  }

  var googleCombo = document.querySelector("select.goog-te-combo");
  var langSelect = document.querySelector('.ct-language');
  langSelect.addEventListener('click', function(event) {
    if (!event.target) {
      return;
    }

    var selected = document.querySelector('.ct-language .ct-language-selected');
    if (selected) {
      selected.classList.remove('ct-language-selected');
    }

    var target = event.target;
    while (target && target !== langSelect ) {
      if (target.matches('.lang-select')) {
        break;
      }
      target = target.parentElement;
    }

    if (target && target.matches('.lang-select')) {
      var lang = target.getAttribute('data-lang');
      if (googleCombo.value == lang) {
        restoreLang();
      } else {
        target.parentElement.classList.add('ct-language-selected');
        googleCombo.value = lang;
        triggerHtmlEvent(googleCombo, 'change');
      }
    }

    event.preventDefault();
  });
}
</script>

<script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
</span>
</div>
        </nav>
</div>
  </div>
</header>

<script>
  function initHeader() {
    var lastScrollY = getScrollPos().y;
    var documentElement = document.documentElement;

    function storeScrollData() {
      var y = getScrollPos().y;var scrollStatus = "";

      if (y <= 0) {
        scrollStatus = "top";
      } else if ((window.innerHeight + y) >= document.body.offsetHeight) {
        scrollStatus = "bottom";
      } else {
        var isScrollDown = (y - lastScrollY > 0) ? true : false;
        scrollStatus = isScrollDown ? "down" : "up";
      }

      lastScrollY = y;
      documentElement.setAttribute("data-scroll-status", scrollStatus);
    }

    window.addEventListener('scroll', function(e) {
      storeScrollData();
    });

    storeScrollData();
  }
  document.addEventListener('DOMContentLoaded', initHeader);
</script>
















































































































































<script>
  function hashLocate(hashValue) {
    hashValue = hashValue.replace(/^.*#h-/, '');
    hashValue = decodeURIComponent(hashValue);
    var element = document.getElementById(hashValue);

    if (!element) {
      return;
    }

    var header = document.querySelector('header.site-header');
    var headerRect = header.getBoundingClientRect();
    var headerTop = Math.floor(headerRect.top);
    var headerHeight = Math.floor(headerRect.height);
    var scrollPos = getScrollPos();
    var offsetY = element.offsetTop - (headerTop + headerHeight + 20);

    if (offsetY == scrollPos.y) {
      return;
    }

    if (headerTop == 0  && offsetY > scrollPos.y) {
      offsetY += headerHeight + 2;
    } else if (headerTop < 0  && offsetY < scrollPos.y) {
      offsetY -= headerHeight - 2;
    }

    smoothScrollTo(offsetY);
  }

  // The first event occurred
  window.addEventListener('load', function(event) {
    if (window.location.hash) {
      hashLocate(window.location.hash);
    }
  });

  // The first event occurred
  window.addEventListener('click', function(event) {
    if (event.target.tagName.toLowerCase() == 'a') {
      hashLocate(event.target.getAttribute('href'));
    }
  });
</script>
<div class="theme-toggle">
  <input type="checkbox" id="theme-switch">
  <label for="theme-switch">
    <div class="toggle"></div>
    <div class="names">
      <p class="light">Light</p>
      <p class="dark">Dark</p>
    </div>
  </label>
</div>




<script>
  (function() {
    var sw = document.getElementById('theme-switch');
    var html = document.getElementsByTagName('html')[0];
    var nightModeOption = ('auto' || 'auto').toLowerCase();
    var storage = nightModeOption === 'manual'
        ? localStorage
        : sessionStorage;
    var themeData = loadThemeData();

    function saveThemeData(data) {
      storage.setItem('theme', JSON.stringify(data));
    }

    function loadThemeData() {
      var data = storage.getItem('theme');
      try {
        data = JSON.parse(data ? data : '');
      } catch(e) {
        data = { nightShift: undefined, autoToggleAt: 0 };
        saveThemeData(data);
      }
      return data;
    }

    function handleThemeToggle(nightShift) {
      themeData.nightShift = nightShift;
      saveThemeData(themeData);
      html.dataset.theme = nightShift ? 'dark' : 'light';
      setTimeout(function() {
        sw.checked = nightShift ? true : false;
      }, 50);
    }

    function autoThemeToggle() {
      // Next time point of theme toggle
      var now = new Date();
      var toggleAt = new Date();
      var hours = now.getHours();
      var nightShift = hours >= 19 || hours <=7;

      if (nightShift) {
        if (hours > 7) {
          toggleAt.setDate(toggleAt.getDate() + 1);
        }
        toggleAt.setHours(7);
      } else {
        toggleAt.setHours(19);
      }

      toggleAt.setMinutes(0);
      toggleAt.setSeconds(0);
      toggleAt.setMilliseconds(0)

      var delay = toggleAt.getTime() - now.getTime();

      // auto toggle theme mode
      setTimeout(function() {
        handleThemeToggle(!nightShift);
      }, delay);

      return {
        nightShift: nightShift,
        toggleAt: toggleAt.getTime()
      };
    }

    // Listen the theme toggle event
    sw.addEventListener('change', function(event) {
      handleThemeToggle(event.target.checked);
    });

    if (nightModeOption == 'auto') {
      var data = autoThemeToggle();

      // Toggle theme by local setting
      if (data.toggleAt > themeData.autoToggleAt) {
        themeData.autoToggleAt = data.toggleAt;
        handleThemeToggle(data.nightShift);
      } else {
        handleThemeToggle(themeData.nightShift);
      }
    } else if (nightModeOption == 'manual') {
      handleThemeToggle(themeData.nightShift);
    } else {
      var nightShift = themeData.nightShift;
      if (nightShift === undefined) {
        nightShift = nightModeOption === 'on';
      }
      handleThemeToggle(nightShift);
    }
  })();
</script>
<div id="click-to-top" class="click-to-top">
  <i class="fa fa-arrow-up"></i>
</div>
<script>
  (function () {
    const clickToTop = document.getElementById('click-to-top');
    window.addEventListener('scroll', () => {
      if (window.scrollY > 100) {
        clickToTop.classList.add('show')
      }else {
        clickToTop.classList.remove('show')
      }
    });
    clickToTop.addEventListener('click', () => {
      window.smoothScrollTo(0);
    });
  })();
</script>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="framework">
  <section class="main">

     <div class="post">
  <section>









<header class="post-header">
  <h1 class="post-title p-name" itemprop="name headline">UID/GID in Docker</h1>
  <h2 class="post-subtitle">Understanding how uid and gid work in Docker containers and how this can generate a permissions error in the development stage</h2>

  <p class="post-meta">
    <time class="dt-published" datetime="2022-03-16T00:00:00-03:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Mar 16, 2022
    </time>

    
    
































    <span class="post-reading-time left-vsplit"><i class="fa fa-clock-o"></i> About 11 mins</span>
  </p>
<div class="post-tags"><a class="post-tag" href="/tags.html#docker">#docker</a></div></header>
<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="post-content e-content" itemprop="articleBody">

      <p>When you are using Docker in development environment and you use some tool that generates files during development, such as  dependecies managment (e.g. npm, composer) or to compile task (e.g. SCSS to CSS), if you try to delete or modify these files generated by the tool, maybe you will find with permission denied.</p>

<p>We’ll try to undertand why this happens and how you can fix it.</p>

<h2 id="the-problem">The problem</h2>

<p>Let’s start with a container that uses composer to manage the project’s dependencies:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker container run <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>:/var/www <span class="se">\</span>
    <span class="nt">-w</span> /var/www <span class="se">\</span>
    composer:2.2 composer require psr/log
</code></pre></div></div>

<p>If you list the folder, you can see that the user who owns the folders/files generated by composer is root:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 20K
drwxrwxr-x. 3 eva       eva       4.0K mar  27 18:31 ./
drwxr-xr-x. 7 eva       eva       4.0K mar  27 18:29 ../
drwxr-xr-x. 4 root      root      4.0K mar  27 18:31 vendor/
<span class="nt">-rw-r--r--</span><span class="nb">.</span> 1 root      root        53 mar  27 18:31 composer.json
<span class="nt">-rw-r--r--</span><span class="nb">.</span> 1 root      root      2.1K mar  27 18:31 composer.lock
</code></pre></div></div>

<p>So if you try to remove/modify it, you’ll get a permissions error:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">''</span> <span class="o">&gt;</span> composer.json 
bash: composer.json: Permission denied
</code></pre></div></div>

<p>To undertand why this happens, you need to undertand how Linux map the uid (user identifier) and the gid (group identifier).</p>

<p>The Linux kernel is responsible for managing the uid and gid space, and it is the kernel-level syscalls that are used to determine whether the requested privileges should be granted. For example, when a process attempts to write to a file, the kernel examines the uid and gid that created the process to determine if it has sufficient privileges to modify the file. <strong>The important to grant or not privileges is the uid, not the username</strong>.</p>

<p>When we run docker containers, there’s still uses the same kernel as the host. That is, all the processes running inside the containers share the same kernel of the host kernel. This kernel, as we said before, manages all uid and gid.</p>

<p>So you can’t have different users with the same uid inside different containers. So why can I define different usernames (and group names) between containers that have the same uid (and gid)? This is because <strong>username (and group names) that appear in common Linux tools are not part of the kernel, but are managed by external tools</strong> (/etc/passwd, LDAP, Kerberos , etc.). So you might see different usernames, since both host and containers have their own separate list of users and groups in /etc/passwd and /etc/group respectively, but you can’t have different privileges to the same uid/gid.</p>

<p>Now, why are the folders/files generated by composer owned by root?</p>

<p>The reason this happens is that Docker runs on Linux as root, if you follow the recommendations of the official installation. So when you create a new container, it’s not created by the current user, but by the root user which is the daemon running underneath. This is important to consider in order to build a secure system, <strong>if no other option is provided, such as passing a different uid in the Dockerfile, the processes in the containers will run as root</strong>.</p>

<p>You can verify this as follows:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker container run <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>:/var/www <span class="se">\</span>
    <span class="nt">-w</span> /var/www <span class="se">\</span>
    composer:2.2 <span class="nb">whoami
</span>root
</code></pre></div></div>

<p>As you can see, the result of <code class="language-plaintext highlighter-rouge">whoami</code> (which returns the current user) in the container is root. If you run the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker container run <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>:/var/www <span class="se">\</span>
    <span class="nt">-w</span> /var/www <span class="se">\</span>
    composer:2.2 <span class="se">\</span>
        bash <span class="nt">-c</span> <span class="s2">"echo </span><span class="se">\$</span><span class="s2">(id -u </span><span class="se">\$</span><span class="s2">{USER}):</span><span class="se">\$</span><span class="s2">(id -g </span><span class="se">\$</span><span class="s2">{USER})"</span>
0:0
</code></pre></div></div>

<p>You’ll see that the id of the user and group inside the container is 0.</p>

<blockquote>
  <p>It is important to remember that in Linux the root user/group has an id, by convention, which is 0.</p>
</blockquote>

<h2 id="solution-1">Solution 1</h2>

<p>You can run the Docker container as your local user, passing the uid and gid. You can try this as follows:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker container run <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>:/var/www <span class="se">\</span>
    <span class="nt">-w</span> /var/www <span class="se">\</span>
    <span class="nt">-u</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span> <span class="k">${</span><span class="nv">USER</span><span class="k">}</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span> <span class="k">${</span><span class="nv">USER</span><span class="k">}</span><span class="si">)</span> <span class="se">\</span>
    composer:2.2 composer require psr/log
</code></pre></div></div>

<p>If you list the folder, you can see that the user who owns the folders/files generated by composer is the local user:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 20K
drwxrwxr-x. 3 eva eva 4.0K mar  27 19:04 ./
drwxr-xr-x. 7 eva eva 4.0K mar  27 18:29 ../
drwxr-xr-x. 4 eva eva 4.0K mar  27 19:04 vendor/
<span class="nt">-rw-r--r--</span><span class="nb">.</span> 1 eva eva   53 mar  27 19:04 composer.json
<span class="nt">-rw-r--r--</span><span class="nb">.</span> 1 eva eva 2.1K mar  27 19:04 composer.lock
</code></pre></div></div>

<p>Depending on the project being considered, this solution may have a problem. Inside the container, the user is not longer root. If the application inside the container requires perform tasks as root, you’ll get permissions error inside the container. For example, if you want to run a web application with PHP-FPM:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker container run <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>:/var/www <span class="se">\</span>
    <span class="nt">-w</span> /var/www <span class="se">\</span>
    <span class="nt">-u</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span> <span class="k">${</span><span class="nv">USER</span><span class="k">}</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span> <span class="k">${</span><span class="nv">USER</span><span class="k">}</span><span class="si">)</span> <span class="se">\</span>
    composer:2.2 <span class="nb">touch</span> /var/lib/php/sessions/foo
<span class="nb">touch</span>: cannot <span class="nb">touch</span> <span class="s1">'/var/lib/php/sessions/foo'</span>: Permission denied
</code></pre></div></div>

<p>This is because the folder <code class="language-plaintext highlighter-rouge">/var/lib/php/sessions</code> is owned by <code class="language-plaintext highlighter-rouge">www-data:www-data</code>, which most likely does not share your local user’s IDs:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker container run <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>:/var/www <span class="se">\</span>
    <span class="nt">-w</span> /var/www <span class="se">\</span>
    composer:2.2 <span class="se">\</span>
        bash <span class="nt">-c</span> <span class="s2">"echo </span><span class="se">\$</span><span class="s2">(id -u www-data):</span><span class="se">\$</span><span class="s2">(id -g www-data)"</span>
33:33
</code></pre></div></div>

<h2 id="solution-2">Solution 2</h2>

<p>You can replace the internal user/group IDs with known, good values. In this way, you can change the uid/guid of www-data in the container, passing it the uid/guid of the local user.</p>

<p>To do this, you must first create the Dockerfile file to perform this task:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM composer:2.2

ARG USER_ID
ARG GROUP_ID

RUN if [ ${USER_ID:-0} -ne 0 ] &amp;&amp; [ ${GROUP_ID:-0} -ne 0 ]; then \
    userdel -f www-data &amp;&amp;\
    if getent group www-data ; then groupdel www-data; fi &amp;&amp;\
    groupadd -g ${GROUP_ID} www-data &amp;&amp;\
    useradd -l -u ${USER_ID} -g www-data www-data &amp;&amp;\
    install -d -m 0755 -o www-data -g www-data /home/www-data &amp;&amp;\
    chown --changes --silent --no-dereference --recursive \
          --from=33:33 ${USER_ID}:${GROUP_ID} \
        /home/www-data \
        /.composer \
        /var/run/php-fpm \
        /var/lib/php/sessions \
;fi
        
USER www-data
</code></pre></div></div>

<p>Basically what you do in this Dockerfile is pass the id of our current user/group on the host as an environment variable in the container. In the <code class="language-plaintext highlighter-rouge">if [ ${USER_ID:-0} -ne 0 ] &amp;&amp; [ ${GROUP_ID:-0} -ne 0 ]; then</code> line, you allow the USER_ID and GROUP_ID variables to be optional. If both are not defined, the process that follows is skipped. This makes the Dockerfile usable for both development and production purposes.</p>

<p>In case the variables are defined, the user and group www-data are eliminated:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    userdel -f www-data &amp;&amp;\
    if getent group www-data ; then groupdel www-data; fi &amp;&amp;\
</code></pre></div></div>

<p>Then, the user/group are recreated with the default values:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    useradd -l -u ${USER_ID} -g www-data www-data &amp;&amp;\
</code></pre></div></div>

<p>Also, a folder for the user www-data is generated. This is useful if you need your container to perform SSH actions using your host’s SSH keys.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    install -d -m 0755 -o www-data -g www-data /home/www-data &amp;&amp;\
</code></pre></div></div>

<p>In the next line, change the owner to folders that may require updating. In this way, permission error are avoided. To know which are the folders that need to be updated, you can look at the Dockerfile of the image.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    chown --changes --silent --no-dereference --recursive \
          --from=33:33 ${USER_ID}:${GROUP_ID} \
        /home/www-data \
        /.composer \
        /var/run/php-fpm \
        /var/lib/php/sessions \
</code></pre></div></div>

<p>Now, build the image:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker image build <span class="se">\</span>
    <span class="nt">--build-arg</span> <span class="nv">USER_ID</span><span class="o">=</span><span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span> <span class="k">${</span><span class="nv">USER</span><span class="k">}</span><span class="si">)</span> <span class="se">\</span>
    <span class="nt">--build-arg</span> <span class="nv">GROUP_ID</span><span class="o">=</span><span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span> <span class="k">${</span><span class="nv">USER</span><span class="k">}</span><span class="si">)</span> <span class="se">\</span>
    <span class="nt">-t</span> php_test <span class="se">\</span>
    <span class="nb">.</span>
</code></pre></div></div>

<p>Run composer:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker container run <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>:/var/www <span class="se">\</span>
    <span class="nt">-w</span> /var/www <span class="se">\</span>
    php_test:latest composer require psr/log
</code></pre></div></div>

<p>And if you list the folder, you can see as follows:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-lan</span>
total 24K
drwxrwxr-x. 3 1000 1000 4.0K mar  27 19:24 ./
drwxr-xr-x. 7 1000 1000 4.0K mar  27 18:29 ../
drwxr-xr-x. 4 1000 1000 4.0K mar  27 19:24 vendor/
<span class="nt">-rw-rw-r--</span><span class="nb">.</span> 1 1000 1000  545 mar  27 19:19 Dockerfile
<span class="nt">-rw-r--r--</span><span class="nb">.</span> 1 1000 1000   53 mar  27 19:24 composer.json
<span class="nt">-rw-r--r--</span><span class="nb">.</span> 1 1000 1000 2.1K mar  27 19:24 composer.lock
</code></pre></div></div>

<p>The vendor folder generated by composer is owned by the local user’s uid/gid. Inside the container, www-data has this uid/gid. Now you can delete/update without permissions error.</p>

<h3 id="use-docker-compose">Use Docker Compose</h3>

<p>The equivalent docker-compose.yml for this example would be:</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># docker-compose.yml</span>
<span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.2'</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">php</span><span class="pi">:</span>
    <span class="na">build</span><span class="pi">:</span>
      <span class="na">context</span><span class="pi">:</span> <span class="s">.</span>
      <span class="na">dockerfile</span><span class="pi">:</span> <span class="s">Dockerfile</span>
      <span class="na">args</span><span class="pi">:</span>
        <span class="na">USER_ID</span><span class="pi">:</span> <span class="s">${USER_ID:-0}</span>
        <span class="na">GROUP_ID</span><span class="pi">:</span> <span class="s">${GROUP_ID:-0}</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">${HOME}/.composer:/.composer</span>
      <span class="pi">-</span> <span class="s">${PWD}:/var/www</span>
</code></pre></div></div>

<p>The user/group id must be defined in an .env file as below. Docker compose cannot parse commands, so <code class="language-plaintext highlighter-rouge">$(id -u ${USER})</code> would not work in the yaml file.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>USER_ID=1000
GROUP_ID=1000
</code></pre></div></div>

<p>To build the image and run the container, run as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose up -d --build
</code></pre></div></div>

<h2 id="sources">Sources</h2>

<ul>
  <li><a href="https://jtreminio.com/blog/running-docker-containers-as-current-host-user/#ok-so-what-actually-works/">Running Docker Containers as Current Host User</a></li>
  <li><a href="https://www.youtube.com/watch?v=0xUwaz0MD_E">Esto no me lo imaginaba - UID y GIDs en Docker</a></li>
  <li><a href="https://medium.com/@mccode/understanding-how-uid-and-gid-work-in-docker-containers-c37a01d01cf">Understanding how uid and gid work in Docker containers</a></li>
</ul>



    </div>

</article>
<div class="post-nav">
<a class="previous" href="/docker/2022/01/08/https-con-docker-y-apache.html" title="HTTPS with Docker and Apache">HTTPS with Docker and Apache</a><a class="next" href="/react/2022/04/15/better-react-code.html" title="Better React code">Better React code</a>
</div>
<div class="post-related">
      <div>Related Articles</div>
      <ul>
        <li><a class="post-link" href="/docker/2022/03/16/uid-y-gid-en-Docker.html" title="Better React code">UID/GID in Docker</a></li>
<li><a class="post-link" href="/postgres/2021/12/13/connections-pool.html" title="Better React code">Connection Pooling</a></li>
<li><a class="post-link" href="/react/2021/11/26/react-performance.html" title="Better React code">Optimizing Performance in React</a></li>
<li><a class="post-link" href="/postgres/2021/12/18/postgresql-too-many-clients.html" title="Better React code">Sorry, too many clients already - error PostgreSQL</a></li>
</ul>
    </div>
<div class="post-comments"></div></section>
</div>


  </section>
  <section class="sidebar" style="margin-left: 15px;">
    <!-- Get sidebar items --><style type="text/css" media="screen">
.post-menu ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
</style>

<div class="post-menu">
  <div class="post-menu-title">TOC</div>
  <div class="post-menu-content"></div>
</div>

<script>
  function generateContent() {
    var menu = document.querySelector(".post-menu");
    var menuContent =  menu.querySelector(".post-menu-content");
    var headings = document.querySelector(".post-content").querySelectorAll("h2, h3, h4, h5, h6");

    // Hide menu when no headings
    if (headings.length === 0) {
      return menu.style.display = "none";
    }

    // Generate post menu
    var menuHTML = '';
    for (var i = 0; i < headings.length; i++) {
      var h = headings[i];
      menuHTML += (
        '<li class="h-' + h.tagName.toLowerCase() + '">'
        + '<a href="#h-' + h.getAttribute('id') + '">' + h.textContent + '</a></li>');
    }

    menuContent.innerHTML = '<ul>' + menuHTML + '</ul>';

    // The header element
    var header = document.querySelector('header.site-header');

    function doMenuCollapse(index, over_items) {
      var items = menuContent.firstChild.children;

      if (over_items == undefined) {
        over_items = 20;
      }

      if (items.length < over_items) {
        return;
      }

      var activeItem = items[index];
      var beginItem = activeItem
      var endItem = activeItem
      var beginIndex = index;
      var endIndex = index + 1;
      while (beginIndex >= 0
        && !items[beginIndex].classList.contains('h-h2')) {
        beginIndex -= 1;
      }
      while (endIndex < items.length
        && !items[endIndex].classList.contains('h-h2')) {
        endIndex += 1;
      }
      for (var i = 0; i < beginIndex; i++) {
        item = items[i]
        if (!item.classList.contains('h-h2')) {
          item.style.display = 'none';
        }
      }
      for (var i = beginIndex + 1; i < endIndex; i++) {
        item = items[i]
        // if (!item.classList.contains('h-h2')) {
          item.style.display = '';
        // }
      }
      for (var i = endIndex; i < items.length; i++) {
        item = items[i]
        if (!item.classList.contains('h-h2')) {
          item.style.display = 'none';
        }
      }
    }

    // Init menu collapsed
    doMenuCollapse(-1);

    // Active the menu item
    window.addEventListener('scroll', function (event) {
      var lastActive = menuContent.querySelector('.active');
      var changed = true;
      var activeIndex = -1;
      for (var i = headings.length - 1; i >= 0; i--) {
        var h = headings[i];
        var headingRect = h.getBoundingClientRect();
        var headerRect = header.getBoundingClientRect();
        var headerTop = Math.floor(headerRect.top);
        var headerHeight = Math.floor(headerRect.height);
        var headerHeight = headerTop + headerHeight + 20;
        if (headingRect.top <= headerHeight) {
          var id = 'h-' + h.getAttribute('id');
          var a = menuContent.querySelector('a[href="#' + id  + '"]');
          var curActive = a.parentNode;
          if (curActive) {
            curActive.classList.add('active');
            activeIndex = i;
          }
          if (lastActive == curActive) {
            changed = false;
          }
          break;
        }
      }
      if (changed) {
        if (lastActive) {
          lastActive.classList.remove('active');
        }
        doMenuCollapse(activeIndex);
      }
      event.preventDefault();
    });
  }
  generateContent();
</script>
</section>
</div>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">
    <div class="site-footer-inner">
<div>All rights reserved <span class="copyleft">©</span> Eva Villarreal Guzmán 2022 </div>
      <div>Powered by <a title="Jekyll is a simple, blog-aware, static site
      generator." href="https://jekyllrb.com/">Jekyll</a> &amp; <a title="Yat, yet
      another theme." href="https://github.com/jeffreytse/jekyll-theme-yat">Yat Theme</a>.</div>
    </div>
  </div>
</footer>
</body>
</html>
